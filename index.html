<html lang="en">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Angular Material style sheet -->
    <link rel="stylesheet" href="node_modules/angular-material/angular-material.min.css">
</head>

<body ng-app="CerealApp" ng-cloak>
    <div ng-controller="mainCtrl">
        <md-content layout-gt-sm="row" layout-padding>
            <form ng-submit="search()">
                <md-input-container>
                    <label>Show</label>
                    <input ng-model="search.show" required>
                </md-input-container>
                <md-input-container>
                    <label>Season</label>
                    <input ng-model="search.season" required>
                </md-input-container>
                <md-input-container>
                    <label>Episode</label>
                    <input ng-model="search.episode" required>
                </md-input-container>
                <md-button type="submit" aria-label="Search">
                    <ng-md-icon icon="search" ng-show="!search_loading"></ng-md-icon>
                    <!--                     <md-progress-circular class="md-accent md-hue-2" md-mode="indeterminate" md-diameter="20" flex ng-show="search_loading" style="margin-left: 100px;"></md-progress-circular> -->
                </md-button>
            </form>
        </md-content>
        <md-content class="md-padding">
            <md-card ng-repeat="local in locals track by $index">
                <md-card-title>
                    <md-card-title-text>
                        <span class="md-headline">{{ local.show }}</span>
                        <span class="md-subhead">ep {{ local.episode }}</span>
                        <md-progress-linear md-mode="determinate" value="{{ local.download_info.progress }}" ng-show="local.download_info"></md-progress-linear>
                    </md-card-title-text>
                </md-card-title>
                <md-card-content layout="row" layout-align="space-between center center">
                    <img ng-src="{{ local.poster }}" class="md-card-image">
                    <md-progress-circular class="md-accent md-hue-1" md-mode="indeterminate" md-diameter="100" flex ng-show="!local.download_info && !local.ready" style="margin-left: 100px;"></md-progress-circular>
                    <div layout-align="start" ng-show="!local.ready && local.download_info" flex>
                        <div layout="row" style="padding-left: 10px;">
                            <div flex-gt-sm="66" flex="33">Speed</div>
                            <div flex-gt-sm="33" flex="66">{{ local.download_info.speed }}</div>
                        </div>
                        <div layout="row" style="padding-left: 10px;">
                            <div flex-gt-sm="66" flex="33">Downloaded</div>
                            <div flex-gt-sm="33" flex="66">{{ local.download_info.downloaded }}</div>
                        </div>
                        <div layout="row" style="padding-left: 10px;">
                            <div flex-gt-sm="66" flex="33">Size</div>
                            <div flex-gt-sm="33" flex="66">{{ local.size }}</div>
                        </div>
                        <div layout="row" style="padding-left: 10px;">
                            <div flex-gt-sm="66" flex="33">Seeds</div>
                            <div flex-gt-sm="33" flex="66">{{ local.seeds }}</div>
                        </div>
                        <div layout="row" style="padding-left: 10px;">
                            <div flex-gt-sm="66" flex="33">ETA</div>
                            <div flex-gt-sm="33" flex="66">{{ local.download_info.remaining }}</div>
                        </div>
                    </div>
                    <md-card-actions layout="row" ng-show="local.ready" flex>
                        <md-button class="md-raised md-primary" ng-click="watch(local)" style="margin-left: 100px;">Watch</md-button>
                    </md-card-actions>
                </md-card-content>
            </md-card>
        </md-content>
    </div>
    <!-- Angular Material requires Angular.js Libraries -->
    <script src="node_modules/angular/angular.min.js"></script>
    <script src="node_modules/angular-animate/angular-animate.min.js"></script>
    <script src="node_modules/angular-aria/angular-aria.min.js"></script>
    <script src="node_modules/angular-messages/angular-messages.min.js"></script>
    <!-- Angular Material Library -->
    <script src="node_modules/angular-material/angular-material.min.js"></script>
    <script src="node_modules/angular-material-icons/angular-material-icons.min.js"></script>
    <!-- ngElectron  -->
    <script type="text/javascript">
    angular.module('CerealApp', ['ngMaterial', 'ngMdIcons'])
        .controller('mainCtrl', ['$scope', '$interval', function($scope, $interval) {


            let fsExtra = require('fs-extra');
            let fsPath = require('fs-path');
            let ioc = require('./ioc');
            let logUpdate = require('log-update');
            let chalk = require('chalk');

            let commonService = ioc.create('services/common-service');
            let torrentService = ioc.create('services/torrent-service');
            let jsonService = ioc.create('services/json-service');
            let subService = ioc.create('services/subs-service')

            // console.log('CURRENT TORRENTS -->', torrentService.getCurrents())
            $scope.locals = []

            jsonService.getLocals($scope.locals)
            .then( () => { 
                $scope.$apply() 
            })

            $scope.search = () => {
                $scope.search_loading = true
                if ($scope.search.season.length === 1) $scope.search.season = '0' + $scope.search.season
                if ($scope.search.episode.length === 1) $scope.search.episode = '0' + $scope.search.episode
                torrentService.searchTorrent({
                    show: $scope.search.show,
                    episode: 'S' + $scope.search.season + 'E' + $scope.search.episode
                }).then((torrent) => {
                    console.log('Torrent found:', torrent)
                    torrent.show = commonService.getShowTitleFromTorrent(torrent)
                    $scope.locals.push(torrent)
                    $scope.search_loading = false
                    $scope.$apply()
                    torrentService.downloadTorrent(torrent, $scope).then(() => {
                        console.log('Done')
                    })
                })
            }

            $scope.watch = (local) => {
                let fileName = local.path.split('\\')
                fileName = local.path.split('[')
                let path = fileName[0] + '\\'
                fileName = fileName[0]
                fileName = fileName + '.' + local.extension
                fileName = fileName.split('\\')
                fileName = fileName[fileName.length - 1]
                console.log(local.path + '\\' + fileName)
                commonService.openFile(local.path + '\\' + fileName)
            }

            jsonService.month()
                .then(function(json) {
                    console.log(chalk.yellow('monthly.json file successfully written!'))
                        // Search from my favourites
                    fsExtra.readFile('./backend/json/following.json', (err, data) => {
                        if (err) throw err;
                        console.log(chalk.yellow('following.json found! Searching for today\'s shows..'))
                        let following = JSON.parse(data)
                        let following_torrents = []

                        // dailyShows contains today's shows
                        let today = new Date()
                            // let searchDay = process.argv[2] ? process.argv[2] : 1
                        today.setDate(today.getDate() - 1); // actually yesterday

                        // console.log(json)
                        for (var i = json.length - 1; i >= 0; i--) {
                            var nday = json[i].date

                            if (commonService.sameDay(today, nday)) {

                                console.log()
                                console.log(chalk.inverse(json[i].date_label))
                                console.log(json[i].shows)
                                console.log()

                                getMatch(json[i])
                            }
                        }

                        // Then cycle through dailyShows to match myFollowing   
                        function getMatch(day) {
                            var dailyShows = day.shows;
                            for (var i = following.length - 1; i >= 0; i--) {
                                var myTitle = following[i].title;
                                for (var j = dailyShows.length - 1; j >= 0; j--) {
                                    if (myTitle.toUpperCase() === dailyShows[j].title.toUpperCase()) { // perfect match is bs!
                                        let searchObj = {
                                                show: dailyShows[j].title,
                                                episode: dailyShows[j].episode
                                            }
                                            // console.log('searchObj', searchObj)
                                        following_torrents.push(torrentService.searchTorrent(searchObj));
                                    }
                                }
                            }
                            Promise.all(following_torrents).then(function(results) {
                                console.log()
                                console.log(chalk.green(results.length, 'instances found'))
                                console.log()

                                let torrentsArray = []
                                if (results.length > 0) {
                                    for (var i = results.length - 1; i >= 0; i--) {
                                        // following.filter((followed_show) => {
                                        //     console.log('results[i]', results[i])
                                        //     if (followed_show.title.toLowerCase() === results[i].show.toLowerCase()) {
                                        //         results[i].poster = followed_show.poster
                                        //     }
                                        // })
                                        console.log('---->', results[i])
                                        $scope.locals.push(results[i])
                                        torrentsArray.push(torrentService.downloadTorrent(results[i], $scope))
                                    }
                                    $scope.$apply()
                                    Promise.all(torrentsArray).then((results) => {
                                        console.log(chalk.green('Done\n'))
                                    })
                                } else {
                                    return console.log(chalk.bgBlack('Nothing to see today'))
                                }
                            }).catch(function(e) {
                                return console.error(chalk.red('That\'s bullshit! ->', e))
                            })

                        }

                    })
                })

        }])
        // require('./backend/main.js')

    require('./backend/services/torrent-service.js')
    require('./backend/services/json-service.js')
    require('./renderer.js')
    </script>
</body>

</html>
